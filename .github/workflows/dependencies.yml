name: Dependencies

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 09:00 UTC (æ—¥æœ¬æ™‚é–“ 18:00) ã«å®Ÿè¡Œ
    - cron: '0 9 * * 1'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

env:
  CARGO_TERM_COLOR: always

jobs:
  check-dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ubuntu-latest-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Install cargo-outdated
      run: cargo install cargo-outdated
    
    - name: Install cargo-audit
      run: cargo install cargo-audit
    
    - name: Install cargo-deny
      run: cargo install cargo-deny
    
    - name: Check for outdated dependencies
      run: |
        echo "## å¤ã„ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        cargo outdated --root-deps-only >> $GITHUB_STEP_SUMMARY || true
    
    - name: Security audit
      run: |
        echo "## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»" >> $GITHUB_STEP_SUMMARY
        cargo audit >> $GITHUB_STEP_SUMMARY || true
    
    - name: License and dependency check
      run: |
        echo "## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ»ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        cargo deny check >> $GITHUB_STEP_SUMMARY || true
    
    - name: Update dependencies (dry-run)
      run: |
        echo "## ä¾å­˜é–¢ä¿‚æ›´æ–° (ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³)" >> $GITHUB_STEP_SUMMARY
        cargo update --dry-run >> $GITHUB_STEP_SUMMARY || true

  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Update dependencies
      run: cargo update
    
    - name: Run tests with updated dependencies
      run: cargo test --verbose
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update dependencies"
        title: "ğŸ”§ ä¾å­˜é–¢ä¿‚ã®è‡ªå‹•æ›´æ–°"
        body: |
          ## ä¾å­˜é–¢ä¿‚ã®è‡ªå‹•æ›´æ–°
          
          ã“ã®PRã¯ä¾å­˜é–¢ä¿‚ã‚’æœ€æ–°ç‰ˆã«æ›´æ–°ã—ã¾ã™ã€‚
          
          ### å¤‰æ›´å†…å®¹
          - Cargo.lockã®æ›´æ–°
          - å…¨ãƒ†ã‚¹ãƒˆãŒé€šéã™ã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿
          
          ### ç¢ºèªäº‹é …
          - [ ] ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«é€šéã™ã‚‹
          - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã«å•é¡ŒãŒãªã„
          - [ ] ç ´å£Šçš„å¤‰æ›´ãŒãªã„ã“ã¨ã‚’ç¢ºèª
          
          è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸPRã§ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã«ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚
        branch: update-dependencies-${{ github.run_number }}
        delete-branch: true